# 第9回：Websocket通信でScratch3からCubicPyを操作する

![CubicPy Logo](https://creativival.github.io/CubicPyCode/assets/cubicpy_logo.png)

## 今日のミッション
**Scratch3とCubicPyをWebsocket通信で連携させて、ビジュアルプログラミングの力で3D世界を操ろう！**

## 前回のおさらい

前回は「3Dアート：立体フラクタル図形の世界」と題して、再帰関数を使った神秘的な立体フラクタルの作成を学びました。部分が全体と似た形を持つフラクタルの特性を活かして、少ないコード量で複雑で美しい3D構造を生み出しましたね。今回は視点を変えて、ビジュアルプログラミング言語「Scratch3」からCubicPyを操作する方法を探求していきましょう！

## Websocket通信の基本を理解しよう

### Websocketとは？

Websocketとは、WebブラウザとWebサーバーの間でリアルタイム双方向通信を可能にする技術です。従来のHTTP通信と異なり、一度接続が確立されると、クライアントとサーバーの両方がいつでもデータを送受信できるようになります。

Websocketの主な特徴は以下の通りです：

1. **双方向通信**: サーバーとクライアントの両方から自由にメッセージを送信できる
2. **常時接続**: 接続が一度確立されると、切断されるまで維持される
3. **低遅延**: オーバーヘッドが少なく、リアルタイム性が高い
4. **クロスプラットフォーム**: 異なるプログラミング言語やプラットフォーム間で通信可能

今回はこのWebsocket技術を使って、Scratch3（クライアント）からCubicPy（サーバー）に指示を送り、3D世界を操作します。

> 💡 **先生からのヒント**: Websocketは「電話」のようなもの。一度電話がつながると、お互いに自由に会話ができるんだ。今回は、Scratch3から「電話」でCubicPyに指示を出すよ！

### Websocketの基本的な仕組み

Websocket通信の流れは以下のようになります：

1. **ハンドシェイク**: クライアントがサーバーにWebsocket接続をリクエスト
2. **接続確立**: サーバーがリクエストを受け入れ、接続が確立される
3. **データ交換**: クライアントとサーバー間で自由にデータを送受信
4. **接続終了**: どちらかが接続を終了するまで通信が続く

この仕組みを使って、Scratch3からCubicPyにリアルタイムで3Dオブジェクトの配置や移動などの指示を送ることができるようになります。

## Scratch3とCubicPyの連携方法

### 必要なツールとセットアップ

CubicPyには、Websocketサーバー機能が内蔵されています。以下のコマンドを使って、Websocketモードで起動することができます：

```bash
cubicpy -x
```

または

```bash
cubicpy --external
```

このコマンドを実行すると、CubicPyはWebsocketサーバーとして起動し、画面左上にルーム番号が表示されます。このルーム番号を使って、Scratch3から接続することができます。

> 🔍 **発見ポイント**: `-x`オプションは「external」（外部）の略で、CubicPyが外部アプリケーションからの接続を受け付けるモードになります。このモードでは、画面左上に表示されるルーム番号が重要です！

### Scratch3側の設定
次に、Scratch3側の設定を行います。今回は、特別な拡張機能を持つScratch3 MODの「Xcratch」を使用します。Xcratchは、Scratch3に新しい機能を追加できるプラットフォームです。CubicPyとの連携には「Voxelamming」という拡張機能を使用します。

Xcratchのセットアップは以下の手順で行います：

1. [Xcratch](https://xcratch.github.io/editor/#https://creativival.github.io/voxelamming-extension/projects/example.sb3)にアクセスします
2. 「Voxelamming」拡張機能が使えるサンプルプロジェクトが開きます。
3. 「Voxelamming」拡張機能のブロックが使えるようになります

![Voxelamming Extension](https://creativival.github.io/CubicPyCode/assets/voxelamming_extension.png)

**▲図1▲ Xcratchに追加したVoxelamming拡張**

### 接続を確立する

Scratch3からCubicPyへの接続を確立するには、以下の手順を行います。開かれたプロジェクトのブロックはそのままで、通信の確認を行います。

1. Scratch3で「ルーム名を〜に接続する」ブロックを使用
2. CubicPy画面に表示されているルーム番号を入力
3. スペースキーを押す、または、ブロックをダブルクリックして、スクリプトを実行すると、Webscoket通信でCubicPyとの通信が行われます。
4. 接続が成功したら、キューブでできた「ハシゴ」が建築されます。

![Sample Ladder Script](https://creativival.github.io/CubicPyCode/assets/sample_ladder.png)

**▲図2▲ ハシゴの建築**

ハシゴが建築できたら、このサンプルコードを改造して、作品作りを開始できます。

## Scratch3で作品作り

### 基本的な操作方法

Scratch3からCubicPyを操作するための基本的なブロックを見ていきましょう。

![Sample Ladder](https://creativival.github.io/CubicPyCode/assets/sample_ladder_script.png)

**▲図3▲ ハシゴの建築のサンプルスクリプト**

1. **接続ブロック**: ルーム名を指定して接続する
2. **箱を作るブロック**: 指定した座標に箱（立方体）を配置する
3. **箱のサイズ設定ブロック**: 作成する箱のサイズを設定する
4. **箱の設置間隔設定ブロック**: 箱を設置する際の時間間隔を設定する（この機能はCubicPyでは動作しません）
5. **箱を削除するブロック**: 指定した座標の箱を削除する
6. **データ送信ブロック**: 設定した箱のデータをCubicPyに送信する

これらのブロックと **( )回繰り返すブロック** を組み合わせることで、Scratch3からCubicPyの3D世界を自由に操作できます。

> 💡 **先生からのヒント**: Voxelammingのブロックはたくさんの種類があるけど、基本的なブロックで作品作りは可能ですよ！　まずは、基本的なブロックの使い方に慣れよう。

### 簡単な建物を作るプログラム

それでは、Scratch3を使って簡単な建物を作るプログラムを作ってみましょう。以下は、そのScratch3のプログラム例です：

![Simple Building Program](https://creativival.github.io/CubicPyCode/assets/cube_10x10x10_script.png)

**▲図4▲ Scratch3での簡単な建物プログラム**

このプログラムでは、以下のことを行っています：

1. ルーム名に接続
2. 箱のサイズを1に設定
4. 三重ループを使って、10x10x10の立方体（ビル）を作成
5. データを送信

プログラムを実行すると、CubicPyの画面に簡単な小屋が表示されるはずです。条件式を使って、中空のビルが建築できました。

![Simple Building Program](https://creativival.github.io/CubicPyCode/assets/cube_10x10x10.png)

**▲図5▲ Scratch3での簡単な建物**

> 💡 **先生からのヒント**: Scratch3のブロックは、マウスでドラッグ＆ドロップで組み立てるので、プログラミング初心者でも直感的に操作できるよ！

### タートルプログラミング方式での操作

Scratch3には「タートルプログラミング」という方式もあります。これは、亀（タートル）が動く方向に沿って線を描いていくプログラミング方法です。CubicPyとの連携では、タートルの移動に合わせてキューブを配置することができます。

タートルプログラミングは以下の手順で始めます：

1. [Xcratch](https://xcratch.github.io/editor/#https://creativival.github.io/voxelamming-turtle-extension/projects/example.sb3)にアクセスします
2. 「Voxelamming Turtle」拡張機能が使えるサンプルプロジェクトが開きます。
3. 「Voxelamming Turtle」拡張機能のブロックが使えるようになります

### 接続を確立する

タートルプログラミングの接続を確立するには、以下の手順を行います。開かれたプロジェクトのブロックはそのままで、通信の確認を行います。

1. Scratch3で「ルーム名を〜に接続する」ブロックを使用
2. CubicPy画面に表示されているルーム番号を入力
3. スペースキーを押す、または、ブロックをダブルクリックして、スクリプトを実行すると、Webscoket通信でCubicPyとの通信が行われます。
4. 接続が成功したら、キューブでできた「ペン立て」が建築されます。

![Turtle Sample](https://creativival.github.io/CubicPyCode/assets/turtle_sample.png)

**▲図6▲ タートルプログラミング方式でのScratch3プログラム**

タートルプログラミングを使うには、「Voxelamming-turtle」拡張を追加する必要があります。この方式では、以下のブロックを使用します。

![Sample Ladder](https://creativival.github.io/CubicPyCode/assets/turtle_sample_script.png)

**▲図7▲ ペン立ての建築のサンプルスクリプト**

1. **前に進むブロック**: 指定した歩数だけ前進し、その軌跡に沿って箱を配置
2. **右に曲がるブロック**: 指定した角度だけ右に向きを変える
3. **左に曲がるブロック**: 指定した角度だけ左に向きを変える
4. **ペンを上げるブロック**: 箱の配置を一時停止
5. **ペンを下ろすブロック**: 箱の配置を再開

この方式の利点は、キャラクターの動きを直感的に制御できることです。特に子どもたちにとっては理解しやすい方法です。

### 螺旋階段をScratch3で作る

設計が難しい「螺旋階段」ですが、タートルプログラミングなら直感的に作成できます。ペン立てのサンプルスクリプトを次のように改造します。

1. 角度を少しずつ上向きにしてスタート
2. 前に進んでから、左に少し曲がる
3. これを繰り返して、螺旋状にキューブを配置する

![Turtle Spiral Script](https://creativival.github.io/CubicPyCode/assets/turtle_spiral_script.png)

**▲図8▲ Scratch3での螺旋階段プログラム**

▲図8▲のサンプルスクリプトを実行すると、螺旋階段が建築できます。

![Turtle Spiral](https://creativival.github.io/CubicPyCode/assets/turtle_spiral.png)

**▲図9▲ Scratch3でのフラクタルツリープログラム**

このプログラムを実行すると、CubicPyの3D世界に美しい螺旋階段が現れるでしょう。

このプログラムでは、左に曲がるときにオブジェクトの衝突を防ぐ工夫をしています。**ペンを上げる** **1 進む** **ペンを下げる** **3 進む** のように、曲がり角でペンを上げることで、オブジェクトの重なりを防止しています。

## チャレンジ：Scratch3で鳥籠を作ろう

最後に、Scratch3を使って鳥籠を作るチャレンジに挑戦しましょう。以下のようなアルゴリズムで作成できます：

1. 角度を上向きに少しずつ変えながら、前に進む
2. 円が描けたら、原点に戻る
3. 右向きに角度を変えて、1を繰り返す

以下は、Scratch3でのタートルプログラミングによる鳥籠プログラムの例です：

![Tuttle Cage Script](https://creativival.github.io/CubicPyCode/assets/turtle_cage_script.png)

**▲図10▲ Scratch3での鳥籠プログラム**

このプログラムを実行すると、CubicPyの3D世界に美しい鳥籠が現れます。

![Tuttle Cage](https://creativival.github.io/CubicPyCode/assets/turtle_cage.png)

**▲図11▲ Scratch3での鳥籠建築**

このプログラムも螺旋階段と同様に、オブジェクトの衝突する箇所を条件式で判定して、オブジェクトを置かないようにしています。

## デバッグのコツ

Websocket通信を使ったプログラミングでよくあるデバッグの問題と解決策をいくつか紹介します：

1. **接続エラー**: サーバーが起動しているか、ルーム番号が正しいか確認します
2. **データ送信のタイミング**: 多くの箱を一度に配置する場合は、送信間隔を調整します
3. **処理速度の問題**: 処理が重い場合は、箱のサイズを大きくして数を減らしてみます
4. **座標系の混乱**: X, Y, Z座標の向きを確認します（CubicPyではY軸が奥行き方向）

## まとめ：今回学んだこと

1. **Websocket通信の基本**: クライアント・サーバー間のリアルタイム双方向通信の仕組み
2. **CubicPyのWebsocketモード**: `-x`オプションでWebsocketサーバーとして機能
3. **Scratch3からの操作**: ビジュアルプログラミングによる3D世界の操作方法
4. **タートルプログラミング**: 直感的な操作方法による3Dオブジェクトの配置
5. **複雑な構造物の作成**: ループやカスタムブロックを使った高度な3D構造の生成方法

これらの技術を組み合わせることで、プログラミング初心者でも直感的に3D世界を創造できるようになりました。

## 次回予告

次回は「物理シミュレーションの世界」と題して、より高度な物理法則を組み込んだ3Dシミュレーションの作り方を学びます。衝突、反発、摩擦などの物理パラメータを調整して、リアルな動きを再現する方法を探求していきましょう！

> 🎮 **宿題（やってみよう）**: 今回学んだWebsocket通信とScratch3の知識を使って、オリジナルの3D作品を作ってみよう。タートルプログラミングを活用したり、ループや条件分岐を駆使したりして、複雑で美しい構造物にも挑戦してみよう！

---

**キューパイでプログラミングを楽しもう！次回もお楽しみに！**