# 第7回：3Dボーリングゲームを作ろう

![CubicPy Logo](https://creativival.github.io/CubicPyCode/assets/cubicpy_logo.png)

## 今日のミッション
**自分だけのボーリング場を作って、本格的な3Dボーリングゲームをプログラミングしよう！**

## 前回のおさらい

前回は「APIモードでパワーアップ！」と題して、CubicPyの高度な機能を学びました。APIモードを使うことで、より自由度の高い3D世界を作れるようになりましたね。今回はその知識を活かして、本格的な3Dボーリングゲームを作っていきましょう！

## ボーリングのルールとゲームデザイン

まずは、ボーリングの基本的なルールをおさらいしましょう。

### ボーリングの基本ルール

1. **フレーム構成**: ボーリングは10フレームで構成される
2. **ピン配置**: 10本のピンが三角形状に配置される
3. **得点計算**: 倒れたピンの本数を得点とする

* 今回作成するボーリングゲームは、コードを簡略化するために、1回投球するとゲーム終了とします。

### ゲームデザイン

シンプルなボーリングゲームから始めて、徐々に機能を追加していきましょう。
1. **ベーシックモード**: 10本のピンを配置し、ボールを投げてピンを倒す
2. **得点モード**: 10本のピンを配置し、倒れたピンの数を得点として表示する

今回は、まずベーシックモードを完成させて、徐々に機能を追加していきます。

## ボーリングピンの配置とボールの動き

まずは基本的なボーリングゲームを作ってみましょう。以下のコードを `bowling_game01.py` という名前で保存してください。

```python
from cubicpy import CubicPyApp

# アプリケーションのインスタンスを作成
app = CubicPyApp()

# 簡単なボウリングゲームのセットアップ
# ピンを配置
pin_positions = [
    (0, 0, 0),  # 1番ピン（先頭）
    (-1, 1, 0), (1, 1, 0),  # 2-3番ピン
    (-2, 2, 0), (0, 2, 0), (2, 2, 0),  # 4-6番ピン
    (-3, 3, 0), (-1, 3, 0), (1, 3, 0), (3, 3, 0),  # 7-10番ピン
]

for pos in pin_positions:
    app.add_cylinder(
        position=(pos[0], pos[1], 0),
        scale=(0.8, 0.8, 3.2),
        color=(1, 1, 1),  # 白
        base_point=1,  # 底面中心
    )

# ボールを作成
ball_size = 1.8
ball_speed = 10

app.add_sphere(
    position=(0, -20, 0),
    scale=(ball_size, ball_size, ball_size),
    color=(0.3, 0.3, 0.8),  # 青
    mass=10,
    velocity=(0, ball_speed, 0),  # 前方向に発射
    base_point=1,  # 底面中心
)

# テキスト表示
app.set_top_left_text('ボウリングゲーム')
app.set_bottom_left_text("操作方法: 矢印キーでカメラ移動、R でリセット")

# アプリを実行
app.run()
```

このコードは、基本的なボーリングゲームの枠組みを実装しています。主な機能は以下の通りです：

1. **ボウリングレーンの作成**: レーンとガターを配置
2. **ピンの配置**: 標準的な10ピン配置
3. **ボールの動き**: 角度とパワーを調整して投げられる

### コードの解説

#### ピンの配置

ピンは三角形状に配置されています。以下のコードでピンの位置を設定しています。

```python
# ピンを配置
pin_positions = [
    (0, 0, 0),  # 1番ピン（先頭）
    (-1, 1, 0), (1, 1, 0),  # 2-3番ピン
    (-2, 2, 0), (0, 2, 0), (2, 2, 0),  # 4-6番ピン
    (-3, 3, 0), (-1, 3, 0), (1, 3, 0), (3, 3, 0),  # 7-10番ピン
]
```

#### ボールの動き

ボールは`velocity`引数で初期速度を指定すると、それに応じた方向と速さでボールが発射されます。

```python
# ボールを作成
ball_size = 1.8
ball_speed = 10

app.add_sphere(
    position=(0, -20, 0),
    scale=(ball_size, ball_size, ball_size),
    color=(0.3, 0.3, 0.8),  # 青
    mass=10,
    velocity=(0, ball_speed, 0),  # 前方向に発射
    base_point=1,  # 底面中心
)
```

`ball_size` はボールの直径、`ball_speed` はボールの速さを決定します。

以上で、ボーリングゲームの`ベーシックモード`が完成しました。ゲームを実行してみましょう。Pythonのスクリプトを直接実行します。

```bash
python bowling_game01.py
```

画面にシリンダー（ピン）とボールが表示されます。（▲図1▲）`スペース` キーを押して、ボールを発射してピンを倒すことができます。

![Bowling Game 01](https://creativival.github.io/CubicPyCode/assets/bowling_game01.png)

**▲図1▲ ボーリングゲーム（ベーシックモード）*


次は、`得点モード`として、倒れたピンの数を数えて、得点として表示する機能を追加します。本格的なゲーム開発に進みます。

### 倒れたピンの検出

ピンが倒れたかどうかを判定するために、CubicPyに内蔵している「ゲームロジック」機能を利用します。この機能は、ゲームスクリプトに最低限の得点機能を追加することができます。

#### ゲームロジックの機能解説

1. オブジェクトを監視して、初期位置から動いたオブジェクトの数をカウントできます。
  a. 監視対象のオブジェクトの形状を `cube` `sphere` `cylinder` から選べます。
  b. カウントする動作を、 `moved`（移動）または `fallen`（転倒）のどちらかを選べます。
2. カウントを得点として、画面左上に表示する
3. オブジェクトがすべて動いたときは、画面左上に「Game Clear」を表示する

ゲームロジックの説明が完了しました。次は、`ベーシックモード`に「ゲームロジック」を組み込む方法を説明します。

#### ゲームロジックの実装

ゲームロジックを組み込んで完成した `得点モード` のコードを示します。`bowling_game01.py` をコピーして、`bowling_game02.py` を作成して、次のコードを記載してください。

```python
from cubicpy import CubicPyApp

# アプリケーションのインスタンスを作成
app = CubicPyApp()

# 簡単なボウリングゲームのセットアップ
# ピンを配置
pin_positions = [
    (0, 0, 0),  # 1番ピン（先頭）
    (-1, 1, 0), (1, 1, 0),  # 2-3番ピン
    (-2, 2, 0), (0, 2, 0), (2, 2, 0),  # 4-6番ピン
    (-3, 3, 0), (-1, 3, 0), (1, 3, 0), (3, 3, 0),  # 7-10番ピン
]

for pos in pin_positions:
    app.add_cylinder(
        position=(pos[0], pos[1], 0),
        scale=(0.8, 0.8, 3.2),
        color=(1, 1, 1),  # 白
        base_point=1,  # 底面中心
    )

# ボールを作成
ball_size = 1.8
ball_speed = 10

app.add_sphere(
    position=(0, -20, 0),
    scale=(ball_size, ball_size, ball_size),
    color=(0.3, 0.3, 0.8),  # 青
    mass=10,
    velocity=(0, ball_speed, 0),  # 前方向に発射
    base_point=1,  # 底面中心
)

# テキスト表示
app.set_top_left_text('ボウリングゲーム')
app.set_bottom_left_text("操作方法: 矢印キーでカメラ移動、R でリセット")

# # アプリを実行
# app.run()  # （1）

# ゲームロジックを追加して、移動したピンの数をスコア表示する
try:  # ここから（2）
    # ゲームロジックの初期化
    app.game_logic.target_type = 'cylinder'  # ターゲットをピンに設定
    app.game_logic.motion_state = 'fallen'  # 倒れた状態を監視
    app.game_logic.angle_tolerance = 45  # 倒れたとみなす角度

    # ゲームロジックの開始（サブスレッド）
    app.game_logic.start()

    # シミュレーションを実行（メインスレッド）
    app.run()
finally:
    # ゲームロジックの停止
    app.game_logic.stop()  # ここまで（2）
```

上記のコードは、得点機能を追加した完成版のボーリングゲームです。

（1）の１行をコメントにして無効にします。そして、（2）のコードを追記します。

（2）のコードは、ゲームロジックの初期化で、シリンダー（ピン）が倒れた数をカウントするように設定します。ゲームロジックの開始は自動的にサブスレッドで実行され、ゲームの進行を妨げることなく、ピンの状態を監視し続けます。

ゲームアプリはメインスレッドで実行されます。ゲームアプリが終了したら、finallyブロックで指定した「app.game_logic.stop()」が実行され、サブスレッドが安全に停止します。

以上で、ボーリングゲームの`得点モード`が完成しました。ゲームを実行してみましょう。Pythonのスクリプトを直接実行します。

```bash
python bowling_game02.py
```

画面にシリンダー（ピン）とボールが表示されます。`スペース` キーを押して、ボールを発射してピンを倒すことができます。倒れたピンの本数が得点として表示されるようになりました（▲図2▲）。

![Bowling Game 02](https://creativival.github.io/CubicPyCode/assets/bowling_game02.png)

**▲図2▲ ボーリングゲーム（得点モード）*

以上で、ボーリングゲームは完成です。「ゲームロジック」機能を使えば、簡単なコードを追記するだけで得点機能を追加できます。

## チャレンジ：オリジナルの壁破壊ゲームを作ろう

基本的な3Dボーリングゲームができたので、次は自分だけの「壁破壊ゲーム」を作ってみましょう！以下のようなアイデアで拡張してみてください。

1. 障害物を壁に変更
2. ボールの投げ上げる角度を設定できる

この変更を実装するために、`wall_game.py` を作成して、次のコードを記載します。

```python
from math import cos, sin, radians
from cubicpy import CubicPyApp

# アプリケーションのインスタンスを作成
app = CubicPyApp()

# 壁を配置
for j in range(10):
    for i in range(-5, 5):
        app.add_cube(
            position=(i, 0, j),
            scale=(1, 1, 1),
            color=(1, 1, 1),  # 白
        )

# ボールを作成

ball_size = 1.8
ball_speed = 10
ball_angle = 15

app.add_sphere(
    position=(0, -30, 0),
    scale=(ball_size, ball_size, ball_size),
    color=(0.3, 0.3, 0.8),  # 青
    mass=10,
    velocity=(0, ball_speed * cos(radians(ball_angle)), ball_speed * sin(radians(ball_angle))),  # 前方向に発射
    base_point=1,  # 底面中心
)

# テキスト表示
app.set_top_left_text('壁破壊ゲーム')
app.set_bottom_left_text("操作方法: 矢印キーでカメラ移動、R でリセット")

# # アプリを実行
# app.run()

# ゲームロジックを追加して、移動したピンの数をスコア表示する
try:
    # ゲームロジックの初期化
    app.game_logic.target_type = 'cube'  # ターゲットをピンに設定
    app.game_logic.tolerance = 10  # 動いたとみなす閾値
    app.game_logic.motion_state = 'moved'  # 倒れた状態を監視

    # ゲームロジックの開始（サブスレッド）
    app.game_logic.start()

    # シミュレーションを実行（メインスレッド）
    app.run()
finally:
    # ゲームロジックの停止
    app.game_logic.stop()
```

## 完成したボウリングゲームの実行

以上のコードを組み合わせて、オリジナルの3D壁破壊ゲームを作成できました！Pythonのスクリプトを直接実行します。

```bash
python wall_game.py
```

画面に壁とボールが表示されます。`スペース` キーを押して、ボールを発射して壁を破壊できます（▲図3▲）。

![Wall Game](https://creativival.github.io/CubicPyCode/assets/wall_game.png)

**▲図3▲ 壁破壊ゲーム（得点モード）*

以上で、壁破壊ゲームは完成です。ボールの位置や速度、壁のサイズを変更して、破壊過程を楽しんでください。

## デバッグのコツ

3Dゲームを作るときに役立つデバッグのコツをいくつか紹介します：

1. **位置関係の確認**: カメラを移動して、オブジェクトが正しい位置に配置されているか確認しましょう
2. **物理挙動の調整**: 重力係数（`gravity_factor`）を変更して、ピンの倒れやすさを調整できます
3. **エラーログの活用**: `print`文を使って、変数の値や処理の流れを確認することが有効です

## まとめ：今回学んだこと

1. **3Dボーリングゲームの基本実装**: ボウリングレーン、ピン、ボールの配置と物理挙動
2. **スコア計算**: 移動したオブジェクトを検出し、得点を計算する方法
5. **ゲームの改造**: ボーリングや壁など、破壊する対象を変更することで、さまざまなゲームに改造できます。

これらを応用すれば、さらに複雑で面白いゲームを作ることができます。

## 次回予告
次回は「3Dアート：立体フラクタル図形の世界」です。フラクタル図形の美しさと数学的な規則性を活かして、幾何学的なアート作品を作っていきます。再帰的なプログラミングを使って、フラクタルツリーや雪の形状などの立体フラクタルを描いてみましょう。

> 🎮 **宿題（やってみよう）**: 今回紹介したコードを元に、自分だけのボウリングゲームを作ってみよう。障害物の配置やピンの並びを工夫したり、新しいテーマを追加したりして、友達に自慢できるオリジナルゲームを目指そう！

---

**キューパイでプログラミングを楽しもう！次回もお楽しみに！**